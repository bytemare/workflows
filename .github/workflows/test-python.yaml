#
# SPDX-License-Identifier: MIT
#
# Copyright (C) 2025 Daniel Bourdrez. All Rights Reserved.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree or at
# https://spdx.org/licenses/MIT.html
#

---

name: Test Python

on:
  workflow_call:
    inputs:
      python-version:
        description: 'The Python version to use'
        required: false
        type: string
        default: '3.11'

permissions: {}

jobs:
  test-python:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            files.pythonhosted.org:443
            github.com:443
            pypi.org:443

      - name: Checkout repo
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install test dependencies
        run: |
          pip install --require-hashes --only-binary :all: -r tests/requirements-test.txt

      - name: Run tests with coverage
        run: |
          pytest -c .github/pyproject.toml tests/test_ort_report.py \
            --cov=scripts/ort-report \
            --cov-report=xml \
            --cov-report=term \
            -v

      - name: Upload coverage artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: python-coverage
          path: coverage.xml
          retention-days: 1
