#
# SPDX-License-Identifier: MIT
#
# Copyright (C) 2025 Daniel Bourdrez. All Rights Reserved.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree or at
# https://spdx.org/licenses/MIT.html
#

---

name: Codecov

on:
  workflow_call:
    inputs:
      disable_search:
        description: >-
          Disable search for coverage files. This is helpful when specifying
          what files you want to upload with the files option.
        required: false
        type: boolean
        default: true
      coverage-artifact-name:
        description: 'Coverage artifact name generated by the code scan suite'
        type: string
        required: false
        default: ''
      coverage-manifest-path:
        description: 'Manifest path inside the downloaded coverage artifact'
        type: string
        required: false
        default: 'coverage/manifest.json'
    secrets:
      token:
        required: false

permissions: { }

jobs:
  Codecov:
    strategy:
      fail-fast: false
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76
        with:
          disable-sudo: true
          egress-policy: block
          allowed-endpoints: >
              api.codecov.io:443
              api.github.com:443
              cli.codecov.io:443
              github.com:443
              ingest.codecov.io:443
              keybase.io:443
              o26192.ingest.us.sentry.io:443
              objects.githubusercontent.com:443

      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98

      - name: Validate coverage artifact config
        shell: bash
        env:
          ARTIFACT_NAME: ${{ inputs['coverage-artifact-name'] }}
        run: |
          set -euo pipefail
          if [ -z "$ARTIFACT_NAME" ]; then
            echo "coverage-artifact-name must be set when using the artifact-based Codecov workflow." >&2
            exit 1
          fi

      - name: Download coverage artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          name: ${{ inputs['coverage-artifact-name'] }}
          path: .

      - name: Resolve Codecov files from manifest
        id: coverage_files
        shell: bash
        env:
          MANIFEST_PATH: ${{ inputs['coverage-manifest-path'] }}
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json
          import os
          import pathlib

          manifest = pathlib.Path(os.environ["MANIFEST_PATH"])
          if not manifest.is_file():
              raise SystemExit(f"Coverage manifest not found at '{manifest}'.")

          data = json.loads(manifest.read_text(encoding="utf-8"))
          reports = data.get("reports")
          if not isinstance(reports, list) or not reports:
              raise SystemExit("Coverage manifest has no reports.")

          files = []
          for report in reports:
              path = report.get("path")
              include_in_codecov = report.get("codecov", True)
              if not path:
                  raise SystemExit(f"Invalid manifest entry: {report!r}")
              if not isinstance(include_in_codecov, bool):
                  raise SystemExit(f"Invalid codecov flag in manifest entry: {report!r}")
              if include_in_codecov:
                  if not pathlib.Path(path).is_file():
                      raise SystemExit(f"Coverage report '{path}' listed in manifest does not exist.")
                  files.append(path)

          if not files:
              raise SystemExit("No coverage files marked for Codecov in the manifest.")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"files={','.join(files)}\n")
          PY

      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        env:
          CODECOV_TOKEN: ${{ secrets.token }}
        with:
          files: ${{ steps.coverage_files.outputs.files }}
          disable_search: ${{ inputs.disable_search }}
