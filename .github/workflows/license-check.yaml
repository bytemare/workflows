#
# SPDX-License-Identifier: MIT
#
# Copyright (C) 2025 Daniel Bourdrez. All Rights Reserved.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree or at
# https://spdx.org/licenses/MIT.html
#

---

name: License and Dependency Compliance Check

on:
  workflow_call:
    inputs:
      # Dependency Review
      allow_spdx:
        description: "Comma-separated SPDX allow-list"
        required: false
        type: string
        default: "MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,Unlicense,CC0-1.0"
      warn_only:
        description: "Report but do not fail PRs"
        required: false
        type: boolean
        default: false
      use_pr_comment:
        description: "Post summary comment on PR (requires pull-requests: write)"
        required: false
        type: boolean
        default: false
      run_component_detection:
        description: "Populate Dependency Graph on PR SHAs (recommended)"
        required: false
        type: boolean
        default: true

      # ORT + ScanCode (High-assurance mode)
      assurance:
        description: "low | standard | high (runs ORT when 'high' or on v* tags)"
        required: false
        type: string
        default: "standard"
      ort_config_repository:
        description: "Optional ORT config repo (global policy, rules)"
        required: false
        type: string
        default: ""
      ort_config_revision:
        description: "Optional ref/commit for ORT config repo"
        required: false
        type: string
        default: ""
      ort_fail_on:
        description: "Fail-on mode for ORT (violations|issues|never)"
        required: false
        type: string
        default: "violations"
      ort_cli_args:
        description: "Optional extra ORT CLI args (e.g. -P flags)"
        required: false
        type: string
        default: ""

permissions: { }

jobs:
  # Populate Dependency Graph
  component-detection:
    if: ${{ inputs.run_component_detection && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required to submit dependencies to the graph
      id-token: write   # required by the action (OIDC)
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
      - name: Component Detection (Dependency Submission)
        uses: advanced-security/component-detection-dependency-submission-action@c7cb2bbc9360d8a011e4fac7dc542c689415d62f

  # Fast Dependency Review
  dependency-review:
    needs: [component-detection]
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write   # needed only when posting the summary
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493

      # If a repo config exists, use it, else use inline defaults
      - name: Dependency Review (repo config)
        id: review_cfg
        if: ${{ hashFiles('.github/dependency-review-config.yml') != '' }}
        uses: actions/dependency-review-action@8e51299cdfc42118ace4e33e543a1a621a633cf5
        with:
          config-file: .github/dependency-review-config.yml
          comment-summary-in-pr: ${{ inputs.use_pr_comment && 'on-failure' || 'never' }}

      - name: Dependency Review (inline defaults)
        if: ${{ steps.review_cfg.outcome == '' }}
        uses: actions/dependency-review-action@8e51299cdfc42118ace4e33e543a1a621a633cf5
        with:
          allow-licenses: ${{ inputs.allow_spdx }}
          warn-only: ${{ inputs.warn_only }}
          comment-summary-in-pr: ${{ inputs.use_pr_comment && 'on-failure' || 'never' }}

  # High-assurance: ORT end-to-end (Analyzer→Scanner→Evaluator→Reporter)
  ort-high-assurance:
    if: ${{ inputs.assurance == 'high' || (github.ref_type == 'tag' && startsWith(github.ref_name, 'v')) }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493

      # ORT + ScanCode
      - name: Run ORT (policy-driven)
        uses: oss-review-toolkit/ort-ci-github-action@1805edcf1f4f55f35ae6e4d2d9795ccfb29b6021
        with:
          # Optional: global policy repo: if empty, run with defaults
          ort-config-repository: ${{ inputs.ort_config_repository }}
          ort-config-revision:   ${{ inputs.ort_config_revision }}
          # Fail on policy violations (configurable in ORT config)
          fail-on: ${{ inputs.ort_fail_on }}
          # Run full pipeline
          run: cache-dependencies,analyzer,scanner,evaluator,reporter,upload-results
          # Extra CLI args
          ort-cli-args: ${{ inputs.ort_cli_args }}
