#
# SPDX-License-Identifier: MIT
#
# Copyright (C) 2025 Daniel Bourdrez. All Rights Reserved.
#
# This source code is licensed under the MIT license found in the
# LICENSE file in the root directory of this source tree or at
# https://spdx.org/licenses/MIT.html
#

---

name: License Check

on:
  workflow_call:
    inputs:
      # Safe defaults for MIT-licensed OSS. Override per repo if needed.
      allow_spdx:
        description: "Comma-separated SPDX allowlist"
        required: false
        type: string
        default: "MIT,Apache-2.0,BSD-2-Clause,BSD-3-Clause,ISC,Unlicense,CC0-1.0"
      warn_only:
        description: "Report findings but do not fail"
        required: false
        type: boolean
        default: false
      use_pr_comment:
        description: "Write a summary comment to PR (requires extra perm)"
        required: false
        type: boolean
        default: false

permissions: { }

jobs:
  # Ensure the Dependency Graph is populated for this PR.
  prepare-graph:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493

      # Multi-ecosystem dependency submission.
      - name: Submit dependencies (component detection)
        uses: advanced-security/component-detection-dependency-submission-action@c7cb2bbc9360d8a011e4fac7dc542c689415d62f

  dependency-review:
    needs: [prepare-graph]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      comment: ${{ steps.review.outputs.comment-content }}
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493

      # If a repo config exists, use it.
      - name: Dependency Review (repo config)
        id: review_cfg
        if: ${{ hashFiles('.github/dependency-review-config.yml') != '' }}
        uses: actions/dependency-review-action@8e51299cdfc42118ace4e33e543a1a621a633cf5
        with:
          config-file: .github/dependency-review-config.yml

      # Otherwise, use inline defaults.
      - name: Dependency Review (inline)
        id: review
        if: ${{ steps.review_cfg.outcome == '' }}
        uses: actions/dependency-review-action@8e51299cdfc42118ace4e33e543a1a621a633cf5
        with:
          allow-licenses: ${{ inputs.allow_spdx }}
          warn-only: ${{ inputs.warn_only }}
